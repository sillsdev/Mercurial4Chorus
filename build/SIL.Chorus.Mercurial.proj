<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" InitialTargets="Build">
	<PropertyGroup>
		<RootDir Condition="'$(teamcity_version)' == '' Or '$(OS)'!='Windows_NT'">$(MSBuildProjectDirectory)\..</RootDir>
		<RootDir Condition="'$(teamcity_version)' != '' And '$(OS)'=='Windows_NT'">$(teamcity_build_checkoutDir)</RootDir>
		<teamcity_agent_home_dir Condition="'$(teamcity_agent_home_dir)'=='' And '$(OS)'!='Windows_NT'">/var/lib/TeamCity/agent</teamcity_agent_home_dir>
		<BuildCounter Condition="'$(BuildCounter)' == ''">0</BuildCounter>
		<NuGetBuildDir>$(MSBuildProjectDirectory)/../output/files</NuGetBuildDir>
		<PreRelease Condition="'$(PreRelease)' == ''">-beta</PreRelease>
		<PkgVersion Condition="'$(PkgVersion)' == ''">3.0.3$(PreRelease)$(BuildCounter)</PkgVersion>
	</PropertyGroup>

	<Import Project="NuGet.targets"/>

	<Target Name="Build">
		<CallTarget Targets="Clean"/>
		<CallTarget Targets="BuildPackage"/>
	</Target>

	<Target Name="Clean">
		<RemoveDir Directories="$(NuGetBuildDir)/.." />
	</Target>

	<Target Name="BuildPackage" DependsOnTargets="Clean;CheckPrerequisites">
		<PropertyGroup>
			<NuGetPackageDir>$(MSBuildProjectDirectory)/../output</NuGetPackageDir>
			<NuGetRuntimeFolderWin>$(NuGetBuildDir)/runtimes/win/native</NuGetRuntimeFolderWin>
			<NuGetRuntimeFolderLinux64>$(NuGetBuildDir)/runtimes/linux-x64/native</NuGetRuntimeFolderLinux64>
			<NuGetRuntimeFolderLinux32>$(NuGetBuildDir)/runtimes/linux-x86/native</NuGetRuntimeFolderLinux32>
			<NuGetRuntimeAnyFolder>$(NuGetBuildDir)/runtimes/any</NuGetRuntimeAnyFolder>
			<NuGetDocsFolder>$(NuGetBuildDir)/docs</NuGetDocsFolder>
		</PropertyGroup>
		<ItemGroup>
			<Linux64Artifacts Include="$(RootDir)\linux-x64\**\*.*" />
			<Linux32Artifacts Include="$(RootDir)\linux-x86\**\*.*" />
			<WinArtifacts Include="$(RootDir)\win\**\*.*" />
			<Extensions Include="$(RootDir)\MercurialExtensions\**\*.*" />
			<NuSpecFile Include="$(RootDir)\assets\*.nuspec" />
			<TargetFile Include="$(RootDir)\assets\*.targets" />
		</ItemGroup>

		<!-- Libraries -->
		<MakeDir Directories="$(NuGetBuildDir)"/>
		<Copy SourceFiles="@(Linux64Artifacts)" DestinationFolder="$(NuGetRuntimeFolderLinux64)\%(RecursiveDir)" />
		<Copy SourceFiles="@(Linux32Artifacts)" DestinationFolder="$(NuGetRuntimeFolderLinux32)\%(RecursiveDir)" />
		<Copy SourceFiles="@(WinArtifacts)" DestinationFolder="$(NuGetRuntimeFolderWin)\%(RecursiveDir)" />
		<Copy SourceFiles="@(Extensions)" DestinationFolder="$(NuGetRuntimeAnyFolder)\MercurialExtensions\%(RecursiveDir)" />
		<Copy SourceFiles="@(TargetFile)" DestinationFolder="$(NuGetBuildDir)\build" />
		<Copy SourceFiles="@(NuSpecFile)" DestinationFolder="$(NuGetBuildDir)" />
		<Copy SourceFiles="$(RootDir)\README.md" DestinationFolder="$(NuGetDocsFolder)" />
		<Exec Command="$(NuGetCommand) pack -Version $(PkgVersion) -OutputDirectory $(NuGetPackageDir) SIL.Chorus.Mercurial.nuspec"
			WorkingDirectory="$(NuGetBuildDir)"/>
	</Target>

</Project>
